<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro UCI · IPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex,follow">
  <style>
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:#0f172a; color:#e2e8f0;
    }
    header {
      padding: 12px 16px; background:#0b1220;
      border-bottom:1px solid #1f2937;
      display:flex; gap:12px; align-items:center;
    }
    header h1 { font-size: 1rem; margin: 0; font-weight: 700; letter-spacing:.2px; }
    .hint { padding: 8px 16px; background:#111827; color:#cbd5e1; font-size:.9rem; border-bottom:1px solid #1f2937; }
    .wrap { height: calc(100% - 82px); }
    iframe { width: 100%; height: 100%; border: 0; background:#fff; }
    .fallback { padding: 14px 16px; }
    .btn {
      display:inline-block; padding:10px 14px; border-radius:10px;
      background:#22c55e; color:#0f172a;
      text-decoration:none; font-weight:700;
    }
    .btn:focus, .btn:hover { filter: brightness(1.05); }
  </style>
</head>

<body>
  <header>
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#22c55e" viewBox="0 0 16 16" aria-hidden="true">
      <path d="M8 1a7 7 0 1 0 6.938 6.09.5.5 0 0 0-.812-.39A5.5 5.5 0 1 1 8 2.5a.5.5 0 0 0 0-1.5z"/>
      <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 1 0-.896.444A4 4 0 1 1 8 4a.5.5 0 0 0 0-1z"/>
    </svg>
    <h1>Registro UCI · IPS</h1>
  </header>

  <div class="hint" id="updated">
    <!-- Se mostrará la fecha de última actualización -->
  </div>

  <div class="wrap">
    <iframe
      src="https://script.google.com/macros/s/AKfycbwI__wQmEKQmfpzVvdtTDoKc6xqSJekT6DHeLL_saw6NCtlyeXhliSnKURcJtQBK2BY/exec"
      referrerpolicy="no-referrer-when-downgrade"
      allowfullscreen
      loading="eager">
    </iframe>
    <noscript>
      <div class="fallback">
        <p><a class="btn" href="https://script.google.com/macros/s/AKfycbwP2Ppa_f4yxQRugAnlPvXxKW_NhcqBzeulpt0E0LQW3GYtg1ZRGpFXmWON4y-OPaqNFw/exec" target="_blank" rel="noopener">Abrir formulario</a></p>
      </div>
    </noscript>
  </div>

  <!-- Plotly opcional -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- Script de carga de datos y preparación para render -->
  <script>
  async function fetchDataJSON() {
    const url = new URL('assets/data.json', location.href).href + '?v=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('Error al cargar data.json: ' + res.status);
    return res.json();
  }

  function toISODate(s) {
    if (!s) return null;
    if (s instanceof Date && !isNaN(+s)) return s.toISOString().slice(0,10);
    const str = String(s).trim();
    if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.slice(0,10);
    const d = new Date(str);
    return isNaN(+d) ? null : d.toISOString().slice(0,10);
  }

  function normalizeRecord(r) {
    return {
      fec_ing: toISODate(r['Fecha de Ingreso'] || r.fec_ing),
      fec_egr: toISODate(r['Fecha de Egreso'] || r.fec_egr),
      medico: (r['Médico Tratante'] || r.medico || '').trim(),
      tipo:   (r['Tipos de Pacientes'] || r.tipo || '').trim(),
      cond:   (r['Condición al Egreso'] || r.cond || '').trim(),
      vi:     String(r['Ventilación Invasiva'] || r.vi || '').trim(),
      los:    Number(r['Días de Internación'] || r.los || 0),
      kpc:    String(r['KPC/MBL POSITIVO EN PACIENTES'] || r.kpc || '').trim(),
      apache: Number(r['APACHE II a las 24 h del ingreso'] || r.apache || 0),
      sofa:   Number(r['SOFA a las 48 h del ingreso'] || r.sofa || 0),
    };
  }

  async function boot() {
    try {
      const payload = await fetchDataJSON();
      const data = Array.isArray(payload.records) ? payload.records : payload;

      const registros = data.map(normalizeRecord);
      const conFecha = registros.filter(r => !!r.fec_ing);

      const updated = payload.updated || new Date().toISOString().slice(0,16).replace('T',' ');
      document.getElementById('updated').textContent = `Actualizado: ${updated}`;

      if (conFecha.length === 0) {
        alert("No hay datos con 'Fecha de Ingreso' válida.");
        return;
      }

      // Aquí puedes llamar a tus funciones de visualización
      console.log("Registros normalizados:", registros);

    } catch (err) {
      console.error("Error al cargar datos:", err);
      alert("No se pudo cargar assets/data.json. Revisa la consola.");
    }
  }

  boot();
  </script>
</body>
</html>
